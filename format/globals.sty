\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{rl_theory/globals}

\RequirePackage{soul}
\RequirePackage{mathtools}
\RequirePackage{amsmath}
\RequirePackage{amsfonts}
\RequirePackage{xcolor}
\RequirePackage{tikz}
\RequirePackage{calc}
\RequirePackage{xintexpr}
\RequirePackage[many]{tcolorbox}
\RequirePackage{parskip}
\RequirePackage{fullpage}
\RequirePackage{suffix}
\RequirePackage[pdftex, pdfborderstyle={/S/U/W 0}]{hyperref}
\RequirePackage{catchfile}
\RequirePackage{xifthen}

\usetikzlibrary{calc}

\ProcessOptions\relax

\setlength{\headheight}{12pt}

% --- general notation ---
\def\P{{\rm Pr}}
\def\R{\mathbb R}
\def\E{\mathbb E}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\def\noteop #1 #2{\stackrel{\text{(#1)}}{#2}}
\def\edots#1#2#3{#1_{#2},\ldots,#1_{#3}}

\def\todo{\hskip 0pt {\color{gray}{[TODO]}}}
\def\mtodo{\text{\todo}}

\def\fnnot#1#2#3{#1 : #2 \rightarrow #3}

\def\ctext#1{$$\text{#1}$$}
% ---

\newif\iffull
\fullfalse

% --- colors ---
\definecolor{lightlightlightgray}{rgb}{0.95, 0.95, 0.95}
\definecolor{lightlightgray}{rgb}{0.85, 0.85, 0.85}
\definecolor{lightgray}{rgb}{0.70, 0.70, 0.70}
\definecolor{gray}{rgb}{0.50, 0.50, 0.50}
\definecolor{blue}{rgb}{0.56, 0.74, 0.86}
\definecolor{red}{rgb}{1, 0.51, 0.56}
\definecolor{green}{rgb}{0.53, 0.66, 0.42}

\def\hlg#1{\hlc[lightlightlightgray]{#1}}

\newcommand{\hlc}[2][yellow]{{%
  \colorlet{tempcolor}{#1}%
  \sethlcolor{tempcolor}\hl{#2}}%
}
% ---

% --- command processing ---
\def\runcmd#1{\immediate\write18{#1}}

\def\readcmd#1#2{%
  \CatchFileDef{\cftemp}{|"#1"}{}%
  \expandafter\def\expandafter#2\expandafter{\expandafter\stripspace\cftemp\next}%
}%

\def\stripspace#1 \next{#1}
\edef\root{src}
% ---

\def\sc{\setcounter}
\def\nc{\newcounter}
\def\defl#1#2{\expandafter\gdef\csname #1\endcsname{#2}}
\def\getl#1{\csname #1\endcsname}

\nc{a}
\nc{b}
\nc{c}
\nc{d}

\def\ifbool{\xintifboolexpr}
\def\defeq{\coloneqq}

\renewcommand{\labelitemi}{--}
\renewcommand{\labelitemii}{--}
\renewcommand{\labelitemiii}{--}
\renewcommand{\labelitemiv}{--}

\makeatletter
\newcommand*{\Ifinlist}[2]{%
  \edef\tempa{#1}%
  \edef\tempb{#2}%
  \expandafter\expandafter\expandafter\in@\expandafter\expandafter\expandafter{\expandafter\expandafter\expandafter,\expandafter\tempa\expandafter,\expandafter}\expandafter{\expandafter,\tempb,}%
  \ifin@
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi
}
\makeatother

% --- linking ---
\def\lnraw#1#2{%
  \iffull%
  \hyperref[#1]{#2}%
  \else%
  \href{#1}{#2}%
  \fi%
}

\renewcommand\ln[4][]{%
  \def\templntext{\lnfmt[#1]{#3}{#4}}%
  \lnraw{#2}{\templntext}%
}

\newcommand\lnl[5][]{%
	\iffull%
		\def\temppath{\currreference/#4/#2}%
		\Ifinlist{\temppath}{\firstreflist}{%
		}{%
			\labeltext{\temppath_}%
			\edef\firstreflist{\firstreflist,\temppath}%
		}%
		\ln[#1]{\temppath}{#3}{#5}%
	\else%
		\ln[#1]{#4/#2/ref.pdf}{#3}{#5}%
	\fi%
}

\newcommand\lnproof[3][]{\lnl[#1]{#2}{#3}{proof}{P}}
\newcommand\lnnote[3][]{\lnl[#1]{#2}{#3}{note}{N}}
\def\lngproof#1#2{\lng{#1}{#2}{P}}
\def\lngnote#1#2{\lng{#1}{#2}{N}}

\def\lng#1#2#3{%
  \iffull\def\temp{#1}\else\getrelpathln{#1}{\temp}\fi%
  \ln{\temp}{#2}{#3}%
}

\newcommand\lnfmt[3][]{%
  \ifthenelse{\equal{#1}{}}%
  {%
    $\color{blue}[$\color{black}#2$\color{blue}]_{\rm{}#3}$%
  }%
  {%
    $\color{blue}\left[\text{\color{black}#2}\color{blue}\right]\!_{\rm{}#3}$%
  }%
}

\def\firstreflist{}

\makeatletter
\newcommand{\labeltext}[1]{%
  \@bsphack
  \csname phantomsection\endcsname % in case hyperref is used
  \def\@currentlabel{#1}{\label{#1}}%
  \@esphack
}
\makeatother

\MakeRobust{\ref}% avoid expanding it when in a textual label
% ---

% --- references ---
\def\includereference#1{
  \begin{reference}{#1}
    \input{\curr/ref.tex}
  \end{reference}
}

\newenvironment{reference}[1]
{
  \def\currreference{#1}
  \newpage
  \iffull
    \labeltext{#1}
  \fi
  \def\curr{\root/#1}
  \gdef\currpath{\pathfmt{#1}}
  %\setcounter{page}{1}
  \pagestyle{fancy}
  \fancyhead[R]{\currpath\vspace{10pt}}
  \inheritdefs
}
{
}
% ---

% --- reference path formatting ---
\def\getrelpathln#1#2{\readcmd{python \root/scripts/relpathln.py "\curr" "\root/#1"}{#2}}

\def\proofd{{\color{blue!80!black}P}}
\def\noted{{\color{blue!80!black}N}}

\def\pathfmt#1{\readcmd{python \root/scripts/path_fmt.py "#1" "\iffull F\else N\fi"}{\temp}\colorbox{lightlightgray}{\temp}}
% ---

% --- boxes ---
\newenvironment{mytcb}[1][]
{
  \begin{tcolorbox}[breakable, #1]
  \parskip=10pt
}
{
  \end{tcolorbox}
}

\newenvironment{proposition}[1][Proposition \currpath.]
{
  \begin{mytcb}[title={#1}, 
    colback=blue!5, colbacktitle=blue!40, coltitle=black, colframe=blue!60!black,
    arc=0.1mm]
}
{
  \end{mytcb}
}

\newenvironment{proof}
{
    \begin{mytcb}[title={Proof.}, 
        colbacktitle=lightlightlightgray, coltitle=black, colback=white, colframe=gray!80!black,
        arc=0.1mm]
}
{
    \end{mytcb}
}

\newenvironment{note}[1][Note \currpath.]
{
  \begin{mytcb}[title={#1}, 
    colback=lightgray!15, colbacktitle=lightgray!30, coltitle=black, colframe=lightgray!60!black,
    arc=0.1mm]
}
{
  \end{mytcb}
}

% ---

\RequirePackage[margin=1in]{geometry}

\def\inheritdefs{\readcmd{\root/scripts/defs_inheritance.sh "\curr"}{\defsinherited} \defsinherited}

% --- header ---
\RequirePackage{fancyhdr}
\pagestyle{fancy}

\renewcommand{\headrulewidth}{0pt}
\setlength{\headheight}{26pt}
% ---
